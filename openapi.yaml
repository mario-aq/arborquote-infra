openapi: 3.0.3
info:
  title: ArborQuote API
  description: |
    REST API for ArborQuote MVP - Tree service quotation management system.

    ## Authentication
    All endpoints except `/auth/*` require JWT authentication.
    Include `Authorization: Bearer <jwt_token>` in request headers.

    ## Features
    - Create, read, update, and delete quotes
    - Upload and manage photos for quote items
    - Generate professional PDF quotes (English & Spanish)
    - Track quote status (draft, sent, accepted, rejected)
    - Support for multiple service types (tree removal, pruning, etc.)
    
    ## Photo Management
    - Photos can be uploaded as base64-encoded data within quote operations
    - Photos can also be uploaded independently via `/photos` endpoint
    - Photos are stored in S3 and returned as presigned URLs (1-hour expiration)
    - Max 3 photos per item, 5MB per photo
    - Supported formats: JPEG, PNG, WebP
    - S3 Path Structure: `{YYYY}/{MM}/{DD}/{userId}/{quoteId}/{itemId}/{filename}`
      - Uses `itemId` (ULID) for stable paths regardless of item ordering
    
    ## PDF Generation
    - Generate professional quote PDFs via `/quotes/{quoteId}/pdf` endpoint
    - Bilingual support: English (en) and Spanish (es)
    - Smart caching: PDFs regenerate only when content changes
    - Hash-based: Ignores timestamps and status changes
    - Presigned URLs valid for 7 days
    - S3 Path Structure: `{userId}/{quoteId}/arbor_quote_{quoteId}_{locale}.pdf`
    - Supports both English (_en) and Spanish (_es) versions
    - Lifecycle: Transitions to STANDARD_IA after 30 days
    
  version: 1.0.0
  contact:
    name: ArborQuote Support
    email: support@arborquote.com
  
servers:
  - url: https://api-dev.arborquote.app
    description: Development server
  - url: https://api.arborquote.app
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: Quotes
    description: Quote management operations
  - name: Photos
    description: Photo upload and management
  - name: PDF
    description: PDF generation and caching
  - name: Auth
    description: Authentication and user management
  - name: User
    description: User profile management
  - name: ShortLinks
    description: Short URL redirects for quote PDFs
  - name: Voice
    description: Voice-first quoting with AI interpretation

paths:
  /auth/login:
    post:
      tags:
        - Auth
      summary: User login
      description: Authenticate user with email and password, returns JWT tokens
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  description: User email address
                  example: user@example.com
                password:
                  type: string
                  minLength: 8
                  description: User password
                  example: mypassword123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                required:
                  - accessToken
                  - refreshToken
                  - idToken
                  - expiresIn
                  - tokenType
                properties:
                  accessToken:
                    type: string
                    description: JWT access token for API authentication
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refreshToken:
                    type: string
                    description: JWT refresh token for obtaining new access tokens
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  idToken:
                    type: string
                    description: JWT ID token containing user information
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expiresIn:
                    type: integer
                    description: Access token expiration time in seconds
                    example: 3600
                  tokenType:
                    type: string
                    enum: [Bearer]
                    example: Bearer
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                  - message
                properties:
                  error:
                    type: string
                    example: AuthenticationError
                  message:
                    type: string
                    example: Invalid email or password
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/signup:
    post:
      tags:
        - Auth
      summary: User signup
      description: Create a new user account
      operationId: signup
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
              properties:
                email:
                  type: string
                  format: email
                  description: User email address
                  example: user@example.com
                password:
                  type: string
                  minLength: 8
                  description: User password (must meet Cognito requirements)
                  example: mypassword123
                name:
                  type: string
                  description: User's full name
                  example: John Doe
      responses:
        '200':
          description: Account created successfully, verification code sent
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - email
                  - needsVerification
                  - confirmed
                properties:
                  message:
                    type: string
                    example: "Verification code sent to email"
                  email:
                    type: string
                    format: email
                    example: "user@example.com"
                  needsVerification:
                    type: array
                    items:
                      type: string
                      enum: [email]
                    description: Which contact methods require verification
                    example: ["email"]
                  confirmed:
                    type: boolean
                    description: Whether the account is confirmed (always false for new accounts)
                    example: false
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          description: Account already exists
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                  - message
                properties:
                  error:
                    type: string
                    example: ValidationError
                  message:
                    type: string
                    example: An account with this email already exists
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/verify:
    post:
      tags:
        - Auth
      summary: Verify signup confirmation code
      description: Confirm a user's email or phone verification code sent during signup
      operationId: verifySignup
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - verificationCode
              properties:
                email:
                  type: string
                  format: email
                  description: Email address used during signup
                  example: user@example.com
                verificationCode:
                  type: string
                  description: 6-digit verification code
                  example: "123456"
      responses:
        '200':
          description: Verification successful
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - email
                properties:
                  message:
                    type: string
                    example: "Email verified successfully"
                  email:
                    type: string
                    format: email
                    example: "user@example.com"
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many failed attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/challenge:
    post:
      tags:
        - Auth
      summary: Respond to authentication challenge
      description: Provide response to authentication challenges like MFA codes or password changes
      operationId: respondToChallenge
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - challengeName
                - challengeResponse
                - session
              properties:
                username:
                  type: string
                  description: Username for the authentication
                  example: user@example.com
                challengeName:
                  type: string
                  enum: [SMS_MFA, SOFTWARE_TOKEN_MFA, NEW_PASSWORD_REQUIRED]
                  description: Type of challenge being responded to
                  example: SMS_MFA
                challengeResponse:
                  type: object
                  description: Challenge-specific response data
                  oneOf:
                    - $ref: '#/components/schemas/SmsMfaResponse'
                    - $ref: '#/components/schemas/SoftwareTokenMfaResponse'
                    - $ref: '#/components/schemas/NewPasswordResponse'
                session:
                  type: string
                  description: Session token from the challenge
                  example: "session-token-here"
      responses:
        '200':
          description: Authentication successful or next challenge required
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/AuthSuccess'
                  - $ref: '#/components/schemas/ChallengeRequired'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          description: Invalid credentials or session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many failed attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/refresh:
    post:
      tags:
        - Auth
      summary: Refresh access token
      description: Exchange refresh token for new access and ID tokens
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Refresh token obtained from login
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - accessToken
                  - idToken
                  - expiresIn
                  - tokenType
                properties:
                  accessToken:
                    type: string
                    description: New JWT access token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  idToken:
                    type: string
                    description: New JWT ID token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expiresIn:
                    type: integer
                    description: Token expiration time in seconds
                    example: 3600
                  tokenType:
                    type: string
                    enum: [Bearer]
                    example: Bearer
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                  - message
                properties:
                  error:
                    type: string
                    example: AuthenticationError
                  message:
                    type: string
                    example: Invalid or expired refresh token
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalError'

  /user:
    get:
      tags:
        - User
      summary: Get user profile
      description: |
        Returns the authenticated user's profile information.
        Only the user themselves can view their own profile.
      operationId: getUser
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                userId: user_001
                name: John Doe
                email: john.doe@example.com
                phone: 555-1234
                address: 123 Main St, Springfield, IL 62701
                companyId: company_001
                createdAt: 2024-01-01T00:00:00Z
                updatedAt: 2024-01-01T00:00:00Z
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: UserNotFound
                message: User profile not found
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      tags:
        - User
      summary: Update user profile
      description: |
        Updates the authenticated user's profile information.
        Only the user themselves can update their own profile.
        All fields are optional - only provided fields will be updated.
      operationId: updateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
            examples:
              updateName:
                summary: Update only the name
                value:
                  name: John Smith
              updateContact:
                summary: Update email and phone
                value:
                  email: john.smith@example.com
                  phone: 555-9876
              updateAll:
                summary: Update all profile fields
                value:
                  name: John Smith
                  email: john.smith@example.com
                  phone: 555-9876
                  address: 456 Oak Avenue, Springfield, IL 62702
      responses:
        '200':
          description: User profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                userId: user_001
                name: John Smith
                email: john.smith@example.com
                phone: 555-9876
                address: 456 Oak Avenue, Springfield, IL 62702
                companyId: company_001
                createdAt: 2024-01-01T00:00:00Z
                updatedAt: 2024-01-15T10:30:00Z
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '403':
          $ref: '#/components/responses/AuthorizationError'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: UserNotFound
                message: User profile not found
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalError'

  /quotes:
    post:
      tags:
        - Quotes
      summary: Create a new quote
      description: |
        Creates a new quote with items and optional photos.
        Photos can be provided as base64-encoded data or as S3 keys from previous uploads.
      operationId: createQuote
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQuoteRequest'
            examples:
              simpleQuote:
                summary: Simple quote without photos
                value:
                  userId: user_001
                  customerName: John Doe
                  customerPhone: 555-1234
                  customerAddress: 123 Oak Street, Springfield, IL 62701
                  items:
                    - type: tree_removal
                      description: Large oak tree in backyard
                      diameterInInches: 36
                      heightInFeet: 45
                      riskFactors: [near_structure, leaning]
                      price: 85000
                  notes: Customer wants work done ASAP
              quoteWithPhotos:
                summary: Quote with base64 photos
                value:
                  userId: user_001
                  customerName: Jane Smith
                  customerPhone: 555-5678
                  customerAddress: 456 Maple Ave
                  items:
                    - type: tree_removal
                      description: Tree with photos
                      price: 75000
                      photos:
                        - data: iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAY...
                          contentType: image/png
                          filename: tree-front.png
              quoteWithS3Keys:
                summary: Quote with pre-uploaded photos (S3 keys)
                value:
                  userId: user_001
                  customerName: Bob Wilson
                  customerPhone: 555-9999
                  customerAddress: 789 Pine St
                  items:
                    - type: tree_removal
                      description: Tree with pre-uploaded photos
                      price: 60000
                      photos:
                        - 2025/11/29/user_001/quote_123/01HQXYZITEM1234567890/photo1.jpg
                        - 2025/11/29/user_001/quote_123/01HQXYZITEM1234567890/photo2.jpg
      responses:
        '201':
          description: Quote created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quote'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'
    
    get:
      tags:
        - Quotes
      summary: List quotes for a user
      description: Returns all quotes for a specific user
      operationId: listQuotes
      description: Returns all quotes for the authenticated user (from JWT)
      responses:
        '200':
          description: List of quotes
          content:
            application/json:
              schema:
                type: object
                properties:
                  quotes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quote'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /quotes/{quoteId}:
    get:
      tags:
        - Quotes
      summary: Get a specific quote
      description: Returns a single quote with presigned URLs for photos
      operationId: getQuote
      parameters:
        - $ref: '#/components/parameters/QuoteId'
      responses:
        '200':
          description: Quote details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quote'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    
    put:
      tags:
        - Quotes
      summary: Update a quote
      description: |
        Updates an existing quote. Can update any field except userId and quoteId.
        When updating items, include itemId to preserve existing items or omit to create new items.
        Photos can be updated similarly - include existing S3 keys or provide new base64 data.
      operationId: updateQuote
      parameters:
        - $ref: '#/components/parameters/QuoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateQuoteRequest'
            examples:
              updateStatus:
                summary: Update only status
                value:
                  status: sent
              updateItems:
                summary: Update items and add photo
                value:
                  status: sent
                  items:
                    - itemId: 01HQXYZITEM1...
                      type: tree_removal
                      description: Updated description
                      price: 95000
                      photos:
                        - data: iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAY...
                          contentType: image/jpeg
                          filename: updated-photo.jpg
      responses:
        '200':
          description: Quote updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quote'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    
    delete:
      tags:
        - Quotes
      summary: Delete a quote
      description: |
        Permanently deletes a quote and all associated photos and PDFs from S3.
        This operation cannot be undone.
      operationId: deleteQuote
      parameters:
        - $ref: '#/components/parameters/QuoteId'
      responses:
        '204':
          description: Quote deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /quotes/{quoteId}/pdf:
    post:
      tags:
        - PDF
      summary: Generate PDF for a quote
      description: |
        Generates a professional PDF document for a quote in the requested language.
        Uses hash-based caching to avoid regenerating unchanged quotes.
        Returns a presigned URL valid for 7 days.
        
        **Locale Support:**
        - Each quote can have up to 2 cached PDFs: one English (_en) and one Spanish (_es)
        - PDFs are cached independently per locale
        - Changing locale does NOT invalidate the other locale's cache
        
        **Caching Behavior:**
        - First request for a locale: Generates PDF and stores in S3
        - Subsequent requests: Returns cached PDF if content unchanged
        - Content change: Automatically regenerates both locales on next request
        - Status changes (draft/sent/accepted) do NOT trigger regeneration
        - Force regenerate: Use `forceRegenerate: true` to bypass cache
        
        **Hash Includes:** Customer info, items (type, description, price, dimensions, risk factors), notes, total price
        
        **Hash Excludes:** Status, timestamps (createdAt/updatedAt), photos, PDF metadata, locale
      operationId: generateQuotePdf
      parameters:
        - $ref: '#/components/parameters/QuoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeneratePdfRequest'
            examples:
              english:
                summary: Generate English PDF
                value:
                  locale: en
              spanish:
                summary: Generate Spanish PDF
                value:
                  locale: es
              forceRegenerate:
                summary: Force regeneration
                value:
                  locale: en
                  forceRegenerate: true
      responses:
        '200':
          description: PDF generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratePdfResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          description: Forbidden - quote does not belong to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /photos:
    post:
      tags:
        - Photos
      summary: Upload photos independently
      description: |
        Upload photos before creating or updating a quote.
        Returns S3 keys that can be used in quote items' photos array.
        Useful for uploading photos progressively or before quote exists.
      operationId: uploadPhotos
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadPhotosRequest'
      responses:
        '201':
          description: Photos uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadPhotosResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'
    
    delete:
      tags:
        - Photos
      summary: Delete a photo
      description: |
        Deletes a photo from S3 using its S3 key.
        Returns 204 even if photo doesn't exist (idempotent operation).
        Note: This only deletes from S3, not from quote records.
      operationId: deletePhoto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeletePhotoRequest'
      responses:
        '204':
          description: Photo deleted successfully
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          description: Forbidden - cannot delete another user's photo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /q/{slug}:
    get:
      tags:
        - ShortLinks
      summary: Redirect to quote PDF via short link
      description: |
        Redirects to a presigned S3 URL for the quote PDF.
        
        Short links are stable and deterministic per (quoteId, locale) pair.
        The same quote in English will always have the same short URL.
        
        Presigned URLs are cached for 7 days to minimize S3 API calls.
        When the cached URL expires, a new one is generated transparently.
        
        **Primary Domain:** https://aquote.link/q/{slug}
        
        **Also accessible via:** https://api.arborquote.app/q/{slug}
        
      operationId: redirectShortLink
      parameters:
        - name: slug
          in: path
          required: true
          description: 8-character short link slug (lowercase alphanumeric)
          schema:
            type: string
            pattern: '^[a-z0-9]{8}$'
            example: a7k9m2n4
      responses:
        '302':
          description: Redirect to PDF presigned URL
          headers:
            Location:
              description: S3 presigned URL for PDF download (valid 7 days)
              schema:
                type: string
                format: uri
                example: https://arborquote-quote-pdfs-dev.s3.amazonaws.com/user_001/01ARZ3NDEKTSV4RRFFQ69G5FAV/arbor_quote_01ARZ3NDEKTSV4RRFFQ69G5FAV_en.pdf?X-Amz-Signature=...
        '404':
          description: Short link not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: ShortLinkNotFound
                message: Short link not found
        '500':
          $ref: '#/components/responses/InternalError'

  /quotes/voice-interpret:
    post:
      tags:
        - Voice
      summary: Interpret voice instructions to update a quote
      description: |
        Voice-first quoting endpoint that interprets spoken instructions and updates a quote draft.
        
        **How it works:**
        1. User records voice instructions (Spanish, English, or mixed)
        2. Frontend sends audio + current quote draft to this endpoint
        3. Backend transcribes audio (Whisper) and interprets instructions (GPT)
        4. Returns updated quote draft for frontend to merge/display
        
        **Key Features:**
        - Auto-detects language (Spanish/English/Spanglish)
        - Stateless: Does NOT save to database
        - Returns updated draft - user decides whether to save
        - Handles price changes, item additions, notes, risk factors
        - No PII sent to AI models (customer/provider info stripped)
        
        **Audio Requirements:**
        - Max size: ~5MB (decoded)
        - Max duration: ~2 minutes recommended
        - Supported formats: webm, mp4, m4a, ogg, wav, mpeg
        
        **Privacy:**
        - Customer/provider PII is stripped before AI processing
        - Audio is processed in-memory only (not stored)
        - Transcripts are not logged in production
      operationId: voiceInterpretQuote
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoiceInterpretRequest'
            examples:
              newQuote:
                summary: Voice instructions for new quote
                value:
                  audioBase64: "UklGRi4AAABXQVZFZm10IBAAAAABAAEA..."
                  audioMimeType: audio/webm
                  quoteDraft:
                    items: []
                    notes: ""
                    status: draft
              existingQuote:
                summary: Update existing quote with voice
                value:
                  audioBase64: "UklGRi4AAABXQVZFZm10IBAAAAABAAEA..."
                  audioMimeType: audio/webm
                  quoteDraft:
                    quoteId: 01ARZ3NDEKTSV4RRFFQ69G5FAV
                    userId: user_001
                    customerName: John Doe
                    customerPhone: "555-1234"
                    customerAddress: 123 Oak St
                    status: draft
                    items:
                      - itemId: 01HQXYZITEM1234567890ABCDE
                        type: tree_removal
                        description: Large oak tree
                        price: 85000
                        riskFactors: [near_structure]
                        photos: []
                    totalPrice: 85000
                    notes: ""
      responses:
        '200':
          description: Voice instructions interpreted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceInterpretResponse'
        '400':
          description: Validation error (invalid audio, missing fields, size exceeded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingField:
                  value:
                    error: ValidationError
                    message: Missing required field 'audioBase64'
                audioTooLarge:
                  value:
                    error: ValidationError
                    message: Audio size exceeds limit (max ~5MB)
                invalidBase64:
                  value:
                    error: ValidationError
                    message: Invalid base64 audio data
        '502':
          description: OpenAI API error (transcription or interpretation failed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                transcriptionError:
                  value:
                    error: TranscriptionError
                    message: Failed to transcribe audio
                interpretationError:
                  value:
                    error: InterpretationError
                    message: Failed to interpret voice instructions
        '500':
          $ref: '#/components/responses/InternalError'

  /feedback:
    post:
      tags:
        - Feedback
      summary: Submit user feedback
      description: |
        Submits user feedback via email to the development team.

        **Requirements:**
        - User must be authenticated
        - Feedback is sent to feedback@arborquote.app
        - Includes user ID, email, and context in email

        **Privacy:**
        - No feedback content is stored in database
        - Only sent via email to development team
      operationId: submitFeedback
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
            examples:
              bugReport:
                summary: Bug report with URL
                value:
                  message: "The quote total calculation is showing incorrect values when I add multiple items"
                  type: "bug"
                  sentFromUrl: "https://app.arborquote.app/quotes/01ARZ3NDEKTSV4RRFFQ69G5FAV"
              featureRequest:
                summary: Feature request
                value:
                  message: "It would be great to have a feature to duplicate quotes"
                  type: "comment"
              question:
                summary: User question
                value:
                  message: "How do I export quotes to PDF?"
                  type: "question"
      responses:
        '200':
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResponse'
              example:
                message: "Feedback submitted successfully"
                feedbackId: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
                submittedAt: "2024-01-01T00:00:00Z"
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        JWT token obtained from `/auth/login` or `/auth/refresh` endpoints.

        Include in request header: `Authorization: Bearer <jwt_token>`

  parameters:
    QuoteId:
      name: quoteId
      in: path
      required: true
      description: ULID of the quote
      schema:
        type: string
        pattern: '^[0-9A-Z]{26}$'
        example: 01ARZ3NDEKTSV4RRFFQ69G5FAV

  schemas:
    CreateQuoteRequest:
      type: object
      required:
        - customerName
        - customerPhone
        - customerAddress
        - items
      properties:
        userId:
          type: string
          description: User ID creating the quote (automatically extracted from JWT authentication)
          example: user_001
          readOnly: true
        customerName:
          type: string
          description: Customer's full name
          example: John Doe
        customerPhone:
          type: string
          description: Customer's phone number
          example: 555-1234
        customerEmail:
          type: string
          format: email
          description: Customer's email address (optional)
          example: john.doe@example.com
        customerAddress:
          type: string
          description: Service location address
          example: 123 Oak Street, Springfield, IL 62701
        items:
          type: array
          description: List of service items (max 10)
          minItems: 1
          maxItems: 10
          items:
            $ref: '#/components/schemas/QuoteItemInput'
        notes:
          type: string
          description: Additional notes about the quote
          example: Customer wants work done by end of month
        status:
          $ref: '#/components/schemas/QuoteStatus'
          default: draft

    UpdateQuoteRequest:
      type: object
      properties:
        customerName:
          type: string
        customerPhone:
          type: string
        customerEmail:
          type: string
          format: email
        customerAddress:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/QuoteItemUpdate'
        notes:
          type: string
        status:
          $ref: '#/components/schemas/QuoteStatus'

    QuoteItemInput:
      type: object
      required:
        - type
        - description
        - price
      properties:
        type:
          $ref: '#/components/schemas/ServiceType'
        description:
          type: string
          description: Detailed description of the service
          example: Large oak tree removal near house
        diameterInInches:
          type: integer
          nullable: true
          description: Tree diameter in inches (for tree-related services)
          example: 36
        heightInFeet:
          type: integer
          nullable: true
          description: Tree height in feet (for tree-related services)
          example: 45
        riskFactors:
          type: array
          description: Risk factors affecting the service
          items:
            type: string
            enum: [near_structure, near_powerlines, leaning, diseased, dead, difficult_access, other]
          example: [near_structure, leaning]
        price:
          type: integer
          description: Price in cents
          example: 85000
        photos:
          type: array
          description: Photos (base64 objects or S3 keys), max 3 per item
          maxItems: 3
          items:
            oneOf:
              - $ref: '#/components/schemas/PhotoUpload'
              - type: string
                description: S3 key from previous upload
                example: 2025/11/29/user_001/quote_123/01HQXYZITEM1234567890/photo.jpg

    QuoteItemUpdate:
      allOf:
        - $ref: '#/components/schemas/QuoteItemInput'
        - type: object
          properties:
            itemId:
              type: string
              description: Existing item ID to update (omit to create new item)
              pattern: '^[0-9A-Z]{26}$'
              example: 01HQXYZITEM1234567890ABCDE

    PhotoUpload:
      type: object
      required:
        - data
        - contentType
      properties:
        data:
          type: string
          format: byte
          description: Base64-encoded image data
          example: iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAY...
        contentType:
          type: string
          enum: [image/jpeg, image/png, image/webp]
          description: MIME type of the image
          example: image/jpeg
        filename:
          type: string
          description: Original filename (optional)
          example: tree-front.jpg

    Quote:
      type: object
      properties:
        quoteId:
          type: string
          pattern: '^[0-9A-Z]{26}$'
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        userId:
          type: string
          example: user_001
        customerName:
          type: string
          example: John Doe
        customerPhone:
          type: string
          example: 555-1234
        customerEmail:
          type: string
          format: email
          example: john.doe@example.com
        customerAddress:
          type: string
          example: 123 Oak Street, Springfield, IL 62701
        status:
          $ref: '#/components/schemas/QuoteStatus'
        items:
          type: array
          items:
            $ref: '#/components/schemas/QuoteItem'
        totalPrice:
          type: integer
          description: Total price in cents (sum of all items)
          example: 125000
        notes:
          type: string
          example: Customer prefers morning appointments
        createdAt:
          type: string
          format: date-time
          example: 2025-11-29T14:30:00.123Z
        updatedAt:
          type: string
          format: date-time
          example: 2025-11-29T15:45:00.789Z
        pdfS3Key:
          type: string
          nullable: true
          deprecated: true
          description: (Deprecated) Legacy PDF S3 key. Use pdfS3KeyEn or pdfS3KeyEs instead.
          example: user_001/01ARZ3NDEKTSV4RRFFQ69G5FAV/arbor_quote_01ARZ3NDEKTSV4RRFFQ69G5FAV.pdf
        pdfS3KeyEn:
          type: string
          nullable: true
          description: S3 key of English PDF (if exists)
          example: user_001/01ARZ3NDEKTSV4RRFFQ69G5FAV/arbor_quote_01ARZ3NDEKTSV4RRFFQ69G5FAV_en.pdf
        pdfS3KeyEs:
          type: string
          nullable: true
          description: S3 key of Spanish PDF (if exists)
          example: user_001/01ARZ3NDEKTSV4RRFFQ69G5FAV/arbor_quote_01ARZ3NDEKTSV4RRFFQ69G5FAV_es.pdf
        lastPdfHash:
          type: string
          nullable: true
          deprecated: true
          description: (Deprecated) Legacy hash field. Use lastPdfHashEn or lastPdfHashEs instead.
          example: a3d5e8f9c2b1a4d6e7f8g9h0i1j2k3l4m5n6o7p8q9r0s1t2u3v4w5x6y7z8
        lastPdfHashEn:
          type: string
          nullable: true
          description: SHA-256 hash of English PDF content for cache validation
          example: a3d5e8f9c2b1a4d6e7f8g9h0i1j2k3l4m5n6o7p8q9r0s1t2u3v4w5x6y7z8
        lastPdfHashEs:
          type: string
          nullable: true
          description: SHA-256 hash of Spanish PDF content for cache validation
          example: b4e6f9g0c3c2b5d7e8f9g0h1i2j3k4l5m6n7o8p9q0r1s2t3u4v5w6x7y8z9

    QuoteItem:
      type: object
      properties:
        itemId:
          type: string
          pattern: '^[0-9A-Z]{26}$'
          example: 01HQXYZITEM1234567890ABCDE
        type:
          $ref: '#/components/schemas/ServiceType'
        description:
          type: string
          example: Large oak tree removal
        diameterInInches:
          type: integer
          nullable: true
          example: 36
        heightInFeet:
          type: integer
          nullable: true
          example: 45
        riskFactors:
          type: array
          items:
            type: string
          example: [near_structure, leaning]
        price:
          type: integer
          description: Price in cents
          example: 85000
        photos:
          type: array
          description: Array of presigned S3 URLs (valid for 1 hour)
          items:
            type: string
            format: uri
            example: https://arborquote-photos-dev.s3.amazonaws.com/2025/11/29/user_001/quote_id/01HQXYZITEM1234567890/photo.jpg?X-Amz-Signature=...

    ServiceType:
      type: string
      enum:
        - tree_removal
        - pruning
        - stump_grinding
        - cleanup
        - trimming
        - emergency_service
        - other
      example: tree_removal

    QuoteStatus:
      type: string
      enum:
        - draft
        - sent
        - accepted
        - rejected
      example: draft

    UploadPhotosRequest:
      type: object
      required:
        - photos
      properties:
        userId:
          type: string
          description: User ID uploading the photos (automatically extracted from JWT authentication)
          example: user_001
          readOnly: true
        quoteId:
          type: string
          description: Quote ID if known (optional, generates temp ID if not provided)
          pattern: '^[0-9A-Z]{26}$'
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        itemId:
          type: string
          description: Item ID for organizing photos (optional, generates temp ID if not provided)
          pattern: '^[0-9A-Z]{26}$'
          example: 01HQXYZITEM1234567890ABCDE
        photos:
          type: array
          minItems: 1
          maxItems: 3
          items:
            $ref: '#/components/schemas/PhotoUpload'

    UploadPhotosResponse:
      type: object
      properties:
        photos:
          type: array
          items:
            type: object
            properties:
              s3Key:
                type: string
                description: S3 key to use in quote items
                example: 2025/11/29/user_001/quote_123/01HQXYZITEM1234567890/tree-front.jpg
              filename:
                type: string
                example: tree-front.jpg
              contentType:
                type: string
                example: image/jpeg
        uploadedAt:
          type: string
          format: date-time
          example: 2025-11-29T16:30:00.123Z

    DeletePhotoRequest:
      type: object
      required:
        - s3Key
      properties:
        s3Key:
          type: string
          description: S3 key of the photo to delete
          example: 2025/11/29/user_001/quote_123/01HQXYZITEM1234567890/photo.jpg
        userId:
          type: string
          description: User ID (optional, for validation)
          example: user_001

    GeneratePdfRequest:
      type: object
      properties:
        locale:
          type: string
          enum: [en, es]
          default: en
          description: Language for PDF generation
          example: en
        forceRegenerate:
          type: boolean
          default: false
          description: Force PDF regeneration even if content unchanged
          example: false

    GeneratePdfResponse:
      type: object
      properties:
        quoteId:
          type: string
          pattern: '^[0-9A-Z]{26}$'
          description: Quote ID
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        pdfUrl:
          type: string
          format: uri
          description: Presigned URL for PDF download (valid for 7 days, locale-specific)
          example: https://arborquote-quote-pdfs-dev.s3.amazonaws.com/user_001/01ARZ3NDEKTSV4RRFFQ69G5FAV/arbor_quote_01ARZ3NDEKTSV4RRFFQ69G5FAV_en.pdf?X-Amz-Signature=...
        shortUrl:
          type: string
          format: uri
          description: Short link URL (stable, never expires, redirects to presigned URL)
          example: https://aquote.link/q/a7k9m2n4
        ttlSeconds:
          type: integer
          description: TTL for presigned URL in seconds (1 hour - short links auto-refresh)
          example: 3600
        cached:
          type: boolean
          description: Whether the PDF was served from cache
          example: false

    VoiceInterpretRequest:
      type: object
      required:
        - audioBase64
        - audioMimeType
        - quoteDraft
      properties:
        audioBase64:
          type: string
          format: byte
          description: |
            Base64-encoded audio recording.
            Max size: ~5MB decoded (~7MB base64).
            Recommended duration: Under 2 minutes.
          example: UklGRi4AAABXQVZFZm10IBAAAAABAAEA...
        audioMimeType:
          type: string
          enum: [audio/webm, audio/mp4, audio/m4a, audio/ogg, audio/wav, audio/mpeg]
          description: MIME type of the audio file
          example: audio/webm
        quoteDraft:
          type: object
          description: |
            Current quote draft (same structure as Quote schema).
            Can be a new quote (empty items array) or existing quote with items.
            PII fields will be stripped before AI processing.
          properties:
            quoteId:
              type: string
              description: Quote ID (optional for new quotes)
              example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
            userId:
              type: string
              description: User ID (stripped before AI processing)
              example: user_001
            customerName:
              type: string
              description: Customer name (stripped before AI processing)
              example: John Doe
            customerPhone:
              type: string
              description: Customer phone (stripped before AI processing)
              example: 555-1234
            customerEmail:
              type: string
              description: Customer email (stripped before AI processing)
              example: john@example.com
            customerAddress:
              type: string
              description: Customer address (stripped before AI processing)
              example: 123 Oak St
            status:
              $ref: '#/components/schemas/QuoteStatus'
            items:
              type: array
              items:
                $ref: '#/components/schemas/QuoteItem'
            totalPrice:
              type: integer
              description: Total price in cents
              example: 85000
            notes:
              type: string
              description: Quote notes (can be updated via voice)
              example: Customer wants work done ASAP

    VoiceInterpretResponse:
      type: object
      properties:
        transcript:
          type: string
          description: Transcribed text from the audio recording
          example: Para el primer rbol, bjale doscientos dlares y mrcalo como cerca de la casa
        detectedLanguage:
          type: string
          description: ISO 639-1 language code detected by Whisper
          example: es
        updatedQuoteDraft:
          type: object
          description: |
            Updated quote draft with changes from voice instructions.
            PII fields are NOT included - frontend should merge with original.
            Only modified fields are changed (items, prices, notes, status, etc).
          properties:
            quoteId:
              type: string
              description: Quote ID (if present in original)
              example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
            status:
              $ref: '#/components/schemas/QuoteStatus'
            items:
              type: array
              items:
                $ref: '#/components/schemas/QuoteItem'
            totalPrice:
              type: integer
              description: Recalculated total price in cents
              example: 65000
            notes:
              type: string
              description: Updated notes
              example: Customer wants work done ASAP

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error type
          example: ValidationError
        message:
          type: string
          description: Human-readable error message
          example: Missing required field 'customerName'

    # Challenge Response Schemas
    SmsMfaResponse:
      type: object
      required:
        - SMS_MFA_CODE
      properties:
        SMS_MFA_CODE:
          type: string
          description: 6-digit SMS MFA code
          example: "123456"

    SoftwareTokenMfaResponse:
      type: object
      required:
        - SOFTWARE_TOKEN_MFA_CODE
      properties:
        SOFTWARE_TOKEN_MFA_CODE:
          type: string
          description: 6-digit TOTP code from authenticator app
          example: "123456"

    NewPasswordResponse:
      type: object
      required:
        - NEW_PASSWORD
      properties:
        NEW_PASSWORD:
          type: string
          minLength: 8
          description: New password meeting Cognito requirements
          example: "newpassword123"

    AuthSuccess:
      type: object
      required:
        - message
        - accessToken
        - refreshToken
        - idToken
        - expiresIn
        - tokenType
      properties:
        message:
          type: string
          example: "Authentication successful"
        accessToken:
          type: string
          description: JWT access token
          example: "eyJraWQiOiJmK2dzdFl4UGw2bW4xb1FoSzJQNjRCU0Z..."
        refreshToken:
          type: string
          description: JWT refresh token
          example: "eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ..."
        idToken:
          type: string
          description: JWT ID token
          example: "eyJraWQiOiJmK2dzdFl4UGw2bW4xb1FoSzJQNjRCU0Z..."
        expiresIn:
          type: integer
          description: Token expiration time in seconds
          example: 3600
        tokenType:
          type: string
          example: "Bearer"

    ChallengeRequired:
      type: object
      required:
        - challenge
        - session
      properties:
        challenge:
          type: string
          enum: [SMS_MFA, SOFTWARE_TOKEN_MFA, NEW_PASSWORD_REQUIRED]
          description: Type of challenge required
          example: "SMS_MFA"
        session:
          type: string
          description: Session token for challenge response
          example: "session-token-here"
        parameters:
          type: object
          description: Additional challenge parameters
          example: {}

    FeedbackRequest:
      type: object
      required:
        - message
        - type
      properties:
        message:
          type: string
          description: Feedback message from the user
          minLength: 1
          maxLength: 1000
          example: "I found a bug in the quote calculation"
        type:
          type: string
          enum: [bug, comment, question, complaint, other]
          description: Type of feedback
          example: "bug"
        sentFromUrl:
          type: string
          format: uri
          description: URL where the feedback was submitted from (optional)
          example: "https://app.arborquote.app/quotes/01ARZ3NDEKTSV4RRFFQ69G5FAV"

    FeedbackResponse:
      type: object
      properties:
        message:
          type: string
          example: "Feedback submitted successfully"
        feedbackId:
          type: string
          description: Unique identifier for the feedback submission
          example: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
        submittedAt:
          type: string
          format: date-time
          description: Timestamp when feedback was submitted
          example: "2024-01-01T00:00:00Z"

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            missingField:
              value:
                error: ValidationError
                message: Missing required field 'customerName'
            invalidPhoto:
              value:
                error: ValidationError
                message: Photo size exceeds 5MB limit
            tooManyPhotos:
              value:
                error: ValidationError
                message: Maximum 3 photos per item

    User:
      type: object
      required:
        - userId
        - name
        - email
      properties:
        userId:
          type: string
          description: Unique user identifier
          example: user_001
        name:
          type: string
          description: User's full name
          example: John Doe
        email:
          type: string
          format: email
          description: User's email address
          example: john.doe@example.com
        phone:
          type: string
          description: User's phone number
          example: 555-1234
        address:
          type: string
          description: User's business address
          example: 123 Business St, Springfield, IL 62701
        companyId:
          type: string
          description: Associated company identifier (read-only)
          example: company_001
          readOnly: true
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: 2024-01-01T00:00:00Z
          readOnly: true
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: 2024-01-01T00:00:00Z
          readOnly: true

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
          description: User's full name
          example: John Doe
        email:
          type: string
          format: email
          description: User's email address
          example: john.doe@example.com
        phone:
          type: string
          description: User's phone number
          example: 555-1234
        address:
          type: string
          description: User's business address
          example: 123 Business St, Springfield, IL 62701
      description: |
        Update user profile. All fields are optional - only provided fields will be updated.
        Note: companyId is read-only and cannot be updated via this endpoint.

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: QuoteNotFound
            message: Quote with ID 01ARZ3NDEKTSV4RRFFQ69G5FAV not found

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: InternalServerError
            message: An unexpected error occurred

    AuthenticationError:
      description: Authentication required or failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            missingToken:
              value:
                error: AuthenticationError
                message: No JWT claims found
            invalidToken:
              value:
                error: AuthenticationError
                message: Invalid JWT token

  example:
    error: AuthorizationError
    message: "Access denied: resource belongs to another user"

  securitySchemes:
    # Future: Add authentication when implementing auth
    # Example:
    # bearerAuth:
    #   type: http
    #   scheme: bearer
    #   bearerFormat: JWT

# Future: Add security requirements when implementing auth
# security:
#   - bearerAuth: []

